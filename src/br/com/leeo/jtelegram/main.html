<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="format-detection" content="telephone=no" />
<!--
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width;" />
        -->
<meta name="viewport"
	content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />

<link rel="stylesheet" type="text/css" href="css/topcoat-mobile-light.min.css">

<title>Uppay</title>

</head>
<body>
	
	<div class="topcoat-navigation-bar">
		<div class="topcoat-navigation-bar__item center full">
			<h1 class="topcoat-navigation-bar__title">
				UpPay
				<a id= 'aLogout' >
					&nbsp;&nbsp;&nbsp;&nbsp;<img id="imgLogout" align="right" src='drawable/logout.png' vspace="25" height='20' width='20'>
				</a> 
			</h1>
		</div>
	</div>

	<font id="fontUserName"> </font>

	<div id="connectionScreen">
		<ul id="ulDevicesList" style= "font-size:32px" class="topcoat-list">
		</ul>
		<div style="margin: 10px">
			<button class="topcoat-button--cta" style= "width: 100%" id="buttonRefreshDevices">Procurar máquinas</button>
		</div>
	</div>

	<button class="topcoat-button" style= "width: 100%; position: fixed; bottom: 0;" id="buttonCreditCard">Cartão de Crédito  &#x1F4B3;</button>

	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript">
	
		document.addEventListener('deviceready', function() {
			
			alert( "deviceready" );
			
			fontUserName.innerHTML= '&nbsp;' + window.localStorage.getItem( "user.displayName" );
			
			refreshDevices();
			
			document.addEventListener('resume', function() {
				refreshDevices();
			}, false );

		}, false);
		
		function refreshDevices(){
			
			bluetoothSerial.isEnabled(
			    function() {
				    
					ProgressIndicator.showSimpleWithLabel(true, "Procurando máquinas...");
		
					bluetoothSerial.list( function(devices) {

						ulDevicesList.innerHTML = "";

						devices.forEach(function(device) {

							if (!device.name.match("UpPay\\d+")) {

								return;
							}

							var listItem = document.createElement('li');

							listItem.setAttribute('deviceUUID', device.uuid);
							listItem.setAttribute('deviceName', device.name);

							listItem.className = "topcoat-list__item";
							listItem.innerHTML = "<img src='drawable/paymen_to.png' height='38' width='38'>&nbsp;&nbsp;&nbsp;" + device.name.replace("UpPay", "Máquina ");

							ulDevicesList.appendChild(listItem);
						});
						ProgressIndicator.hide();
						
					}, function() {
						// alert('ERROR');
						ProgressIndicator.hide();
					});
			    },
			    function() {
					ProgressIndicator.showDeterminateWithLabel(false, 20000, 'Ative o seu bluetooth.');
			    }
			);
		}

		buttonRefreshDevices.ontouchstart = function() {

			refreshDevices();
		};

		buttonCreditCard.ontouchstart = function() {

			if (window.localStorage.getItem("inputCardNumber")) {

				window.location = "mycreditcard.html";
			} else {

				window.location = "creditcard.html";
			}
		};

		ulDevicesList.ontouchstart = function(event) {

			if (window.localStorage.getItem("inputCardNumber")) {

				window.location = "uppay.html?" + event.target.getAttribute('deviceName') + "=" + event.target.getAttribute('deviceUUID');
			} else {

				ProgressIndicator.showDeterminateWithLabel(false, 20000, 'Cartão não cadastrado.');
			}
		};
		
		aLogout.ontouchstart= function(event) {
			
			navigator.notification.confirm('Você deseja sair do Uppay?',
				function(buttonIndex) {
					
					if(buttonIndex == 2){
						
						window.localStorage.removeItem("user.uid");
						
						window.localStorage.removeItem("inputCardNumber");
						window.localStorage.removeItem("inputHolder");
						window.localStorage.removeItem("inputExpirationDate");
						window.localStorage.removeItem("inputSecurityCode");
						
						var db = window.openDatabase ('iam.db', '1.0', 'UPpay', 2 * 1024 * 1024);
						db.transaction (function (tx) {
						    
						    tx.executeSql ("DROP TABLE Logs;", [], null, null);
						});
						
						window.location = "index.html";
					}
					
				}, 'Sair', [ 'Não', 'Sim' ]);
		};
	</script>
</body>
</html>